<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Календарь заказов</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Замените на актуальный URL загрузчика -->
    <script src="https://cdn.amocrm.com/v2/loader.min.js"></script>
    <!-- Добавляем RequireJS для AMD-модулей -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
  </head>
  <body>
    <div id="widget-root"></div>
    <div id="loader">
      <div class="loading-spinner"></div>
    </div>

    <script>
      function showError(message) {
        document.getElementById("widget-root").innerHTML = `
        <div class="error-message">
          <h3>Ошибка загрузки виджета</h3>
          <p>${message}</p>
        </div>
      `;
      }

      function initStandaloneWidget() {
        try {
          // Проверяем, что класс виджета определен
          if (typeof OrdersCalendarWidget !== "undefined") {
            new OrdersCalendarWidget().renderWidget();
          } else {
            showError("Класс виджета не определен. Проверьте script.js");
          }
        } catch (e) {
          showError("Ошибка инициализации: " + e.message);
        }
      }

      // Основная функция инициализации
      function initWidget() {
        // Режим amoCRM
        if (typeof AmoCRM !== "undefined") {
          AmoCRM.widgets
            .load("script.js")
            .then(() => {
              if (typeof OrdersCalendarWidget !== "undefined") {
                new OrdersCalendarWidget().callbacks.render();
              } else {
                showError(
                  "Виджет не загрузился. Проверьте консоль для деталей."
                );
              }
            })
            .catch((e) => showError(e.message));
        }
        // Standalone режим
        else {
          // Загружаем script.js через RequireJS
          require(["script.js"], initStandaloneWidget, function (err) {
            showError("Ошибка загрузки скрипта: " + err.requireModules);
          });
        }
      }

      // Запускаем после загрузки страницы
      document.addEventListener("DOMContentLoaded", function () {
        // Даем 3 секунды на загрузку API amoCRM
        setTimeout(initWidget, 3000);
      });
    </script>
  </body>
</html>
